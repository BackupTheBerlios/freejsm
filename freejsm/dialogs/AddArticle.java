/*
 * AddArticle.java
 *
 * Created on 24 mars 2005, 16:39
 */

package dialogs;

import java.sql.Connection;
import java.sql.ResultSet;
import java.sql.PreparedStatement;

import javax.swing.JOptionPane;

/**
 *
 * @author  nahuel
 */
public class AddArticle extends javax.swing.JDialog {
    static java.awt.Dimension screenSize = java.awt.Toolkit.getDefaultToolkit().getScreenSize();
    private int st_id;
    private int ca_id;
    private int util_id;
    private Connection connex;
    
    /** Creates new form AddArticle */
    public AddArticle(java.awt.Frame parent, boolean modal, Connection connex, int ca_id, int st_id, int util_id) {
        super(parent, modal);
        this.connex = connex;
        this.ca_id = ca_id;
        this.st_id = st_id;
        this.util_id = util_id;
        initComponents();
        initFournEtTVACB();
        this.setLocation((screenSize.width-(this.getSize().width))/2,(screenSize.height-(this.getSize().height))/2);
        this.setTitle("Ajout d'un article");
        this.setSize(408,300);
    }
    
    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    private void initComponents() {//GEN-BEGIN:initComponents
        jPanel1 = new javax.swing.JPanel();
        jPanel8 = new javax.swing.JPanel();
        saisieSousPane1 = new javax.swing.JPanel();
        unitLabel = new javax.swing.JLabel();
        unitField = new javax.swing.JTextField();
        condiLabel = new javax.swing.JLabel();
        condiField = new javax.swing.JTextField();
        saisieSousPane2 = new javax.swing.JPanel();
        qtLabel = new javax.swing.JLabel();
        qtField = new javax.swing.JTextField();
        valueLabel = new javax.swing.JLabel();
        valueField = new javax.swing.JTextField();
        saisieSousPane3 = new javax.swing.JPanel();
        reaproLabel = new javax.swing.JLabel();
        reaproField = new javax.swing.JTextField();
        statusLabel = new javax.swing.JLabel();
        statusCB = new javax.swing.JComboBox();
        jPanel2 = new javax.swing.JPanel();
        saisieCodeLabel = new javax.swing.JLabel();
        saisieCodeField = new javax.swing.JTextField();
        saisieDesignLabel = new javax.swing.JLabel();
        saisieDesignField = new javax.swing.JTextField();
        jPanel3 = new javax.swing.JPanel();
        fournLabel = new javax.swing.JLabel();
        fournCB = new javax.swing.JComboBox();
        tvaLabel = new javax.swing.JLabel();
        tvaCB = new javax.swing.JComboBox();
        actionPane = new javax.swing.JPanel();
        addButton = new javax.swing.JButton();
        delButton = new javax.swing.JButton();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
        jPanel8.setLayout(new javax.swing.BoxLayout(jPanel8, javax.swing.BoxLayout.Y_AXIS));

        jPanel8.setBorder(new javax.swing.border.EtchedBorder());
        saisieSousPane1.setLayout(new java.awt.GridLayout(2, 2));

        unitLabel.setHorizontalAlignment(javax.swing.SwingConstants.RIGHT);
        unitLabel.setText("Unit\u00e9 de mesure   : ");
        saisieSousPane1.add(unitLabel);

        unitField.setColumns(10);
        unitField.setName("AR_UNIT");
        saisieSousPane1.add(unitField);

        condiLabel.setHorizontalAlignment(javax.swing.SwingConstants.RIGHT);
        condiLabel.setText("Conditionnement : ");
        saisieSousPane1.add(condiLabel);

        condiField.setColumns(10);
        condiField.setName("AR_COND");
        saisieSousPane1.add(condiField);

        jPanel8.add(saisieSousPane1);

        saisieSousPane2.setLayout(new java.awt.GridLayout(2, 2));

        qtLabel.setHorizontalAlignment(javax.swing.SwingConstants.RIGHT);
        qtLabel.setText("Qt\u00e9 en stock : ");
        saisieSousPane2.add(qtLabel);

        qtField.setColumns(10);
        qtField.setName("CS_QT");
        saisieSousPane2.add(qtField);

        valueLabel.setHorizontalAlignment(javax.swing.SwingConstants.RIGHT);
        valueLabel.setText("Prix Unitaire : ");
        saisieSousPane2.add(valueLabel);

        valueField.setColumns(10);
        valueField.setName("CS_PRIXUNITAIRE");
        saisieSousPane2.add(valueField);

        jPanel8.add(saisieSousPane2);

        saisieSousPane3.setLayout(new java.awt.GridLayout(2, 2));

        reaproLabel.setText("Seuil de r\u00e9approvisionnement : ");
        saisieSousPane3.add(reaproLabel);

        reaproField.setColumns(10);
        reaproField.setName("CS_SEUIL");
        saisieSousPane3.add(reaproField);

        statusLabel.setHorizontalAlignment(javax.swing.SwingConstants.RIGHT);
        statusLabel.setText("Statut : ");
        saisieSousPane3.add(statusLabel);

        statusCB.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "Disponible", "Non disponible", "N'existe plus" }));
        saisieSousPane3.add(statusCB);

        jPanel8.add(saisieSousPane3);

        jPanel2.setLayout(new java.awt.GridLayout(2, 0));

        saisieCodeLabel.setHorizontalAlignment(javax.swing.SwingConstants.RIGHT);
        saisieCodeLabel.setText("Code : ");
        jPanel2.add(saisieCodeLabel);

        saisieCodeField.setColumns(10);
        saisieCodeField.setName("AR_CODE");
        jPanel2.add(saisieCodeField);

        saisieDesignLabel.setHorizontalAlignment(javax.swing.SwingConstants.RIGHT);
        saisieDesignLabel.setText("D\u00e9signation : ");
        jPanel2.add(saisieDesignLabel);

        saisieDesignField.setColumns(15);
        saisieDesignField.setName("AR_DESIGN");
        jPanel2.add(saisieDesignField);

        jPanel8.add(jPanel2);

        jPanel3.setLayout(new java.awt.GridLayout(2, 0));

        fournLabel.setHorizontalAlignment(javax.swing.SwingConstants.RIGHT);
        fournLabel.setText("Fournisseur : ");
        fournLabel.setName("");
        jPanel3.add(fournLabel);

        fournCB.setName("");
        jPanel3.add(fournCB);

        tvaLabel.setHorizontalAlignment(javax.swing.SwingConstants.RIGHT);
        tvaLabel.setText("TVA : ");
        jPanel3.add(tvaLabel);

        tvaCB.setName("");
        jPanel3.add(tvaCB);

        jPanel8.add(jPanel3);

        jPanel1.add(jPanel8);

        getContentPane().add(jPanel1, java.awt.BorderLayout.NORTH);

        addButton.setIcon(new javax.swing.ImageIcon(getClass().getResource("/com/develog/icones/stock_add_24.png")));
        addButton.setMaximumSize(new java.awt.Dimension(48, 26));
        addButton.setMinimumSize(new java.awt.Dimension(48, 26));
        addButton.setPreferredSize(new java.awt.Dimension(48, 26));
        addButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                addButtonActionPerformed(evt);
            }
        });

        actionPane.add(addButton);

        delButton.setIcon(new javax.swing.ImageIcon(getClass().getResource("/com/develog/icones/stock_cancel_20.png")));
        delButton.setMaximumSize(new java.awt.Dimension(48, 26));
        delButton.setMinimumSize(new java.awt.Dimension(48, 26));
        delButton.setPreferredSize(new java.awt.Dimension(48, 26));
        delButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                delButtonActionPerformed(evt);
            }
        });

        actionPane.add(delButton);

        getContentPane().add(actionPane, java.awt.BorderLayout.SOUTH);

        pack();
    }//GEN-END:initComponents

    private void addButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_addButtonActionPerformed
    try{
            PreparedStatement statement1 = connex.prepareStatement("INSERT INTO ARTICLE (FO_ID, CA_ID, TVA_ID, AR_CODE, AR_DESIGN, AR_UNIT, AR_COND, AR_ACTIV) VALUES(" + ((classes.ComboObjet)fournCB.getSelectedItem()).getID() + "," + ca_id + "," + ((classes.ComboObjet)tvaCB.getSelectedItem()).getID() + ",?,?,?,?,1)");
            //(" + ((classes.ComboObjet)fournCB.getSelectedItem()).getID() + "," + ca_id + "," + ((classes.ComboObjet)tvaCB.getSelectedItem()).getID() + ",'" + saisieCodeField.getText() + "','" + saisieDesignField.getText() + "','" + unitField.getText() + "','" + condiField.getText() + "',1)"
            statement1.setString(1,saisieCodeField.getText());
            statement1.setString(2,saisieDesignField.getText());
            statement1.setString(3,unitField.getText());
            statement1.setString(4,condiField.getText());
            statement1.executeUpdate();
            
            ResultSet rset = connex.prepareStatement("select @@IDENTITY as 'ident'").executeQuery();
            rset.next();
            connex.prepareStatement("INSERT INTO CONTENU_STOCK (ST_ID, AR_ID, CS_QT, CS_SEUIL, CS_EC, CS_PRIXUNITAIRE) VALUES(" + st_id + "," + rset.getInt("ident") + "," + qtField.getText() + "," + reaproField.getText() + ",0,'" + valueField.getText() + "')").executeUpdate();
            PreparedStatement statement2 = connex.prepareStatement("INSERT INTO JOURNAL (UTIL_ID,JO_TABNOM,JO_PRECVAl,JO_NOUVAL,JO_OPERATION) VALUES(" + util_id + ",'ARTICLE','',?,'I')");
            System.out.println(statement2);
            //"INSERT INTO JOURNAL (UTIL_ID,JO_TABNOM,JO_PRECVAl,JO_NOUVAL,JO_OPERATION) VALUES(" + util_id + ",'ARTICLE','','###AR_ID=>" + rset.getInt("ident") + "###FO_ID=>" + ((classes.ComboObjet)fournCB.getSelectedItem()).getID()  + "###CA_ID=>" + ca_id + "###TVA_ID=>" + ((classes.ComboObjet)tvaCB.getSelectedItem()).getID() + "###AR_CODE=>" + saisieCodeField.getText() + "###AR_DESIGN=>" + saisieDesignField.getText() + "###AR_UNIT=>" + unitField.getText() + "###AR_COND=>" + condiField.getText() + "###AR_ACTIV=>1'
            String champ1 = "###AR_ID=>" + rset.getInt("ident") + "###FO_ID=>" + ((classes.ComboObjet)fournCB.getSelectedItem()).getID()  + "###CA_ID=>" + ca_id + "###TVA_ID=>" + ((classes.ComboObjet)tvaCB.getSelectedItem()).getID() + "###AR_CODE=>" + saisieCodeField.getText() + "###AR_DESIGN=>" + saisieDesignField.getText() + "###AR_UNIT=>" + unitField.getText() + "###AR_COND=>" + condiField.getText() + "###AR_ACTIV=>1";
            statement2.setString(1,champ1);
            System.out.println(statement2);
            statement2.executeUpdate();
            
            PreparedStatement statement3 = connex.prepareStatement("INSERT INTO JOURNAL (UTIL_ID,JO_TABNOM,JO_PRECVAl,JO_NOUVAL,JO_OPERATION) VALUES(" + util_id + ",'CONTENU_STOCK','',?,'I')");
            statement3.setString(1,"###ST_ID=>" + st_id + "###AR_ID=>" + rset.getInt("ident") + "###CS_QT=>" + qtField.getText() + "###CS_SEUIL=>" + reaproField.getText() + "###CS_EC=>0###CS_PRIXUNITAIRE=>" + valueField.getText());
            statement3.executeUpdate();
            JOptionPane.showMessageDialog(this,"L'article a correctement été ajouté","Ajout effectué",JOptionPane.INFORMATION_MESSAGE,null);
            this.dispose();
    }catch(Exception e){
        System.out.println("[AddArticle][addButtonActionPerformed] Exception : " + e);
        e.printStackTrace();
        JOptionPane.showMessageDialog(this,"L'article n'a pu être rajouté","Erreur",JOptionPane.ERROR_MESSAGE,null);
    }
    }//GEN-LAST:event_addButtonActionPerformed

    private void delButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_delButtonActionPerformed
        this.dispose();
    }//GEN-LAST:event_delButtonActionPerformed
    private void initFournEtTVACB(){
        try{
            ResultSet tvaRSET = connex.prepareStatement("SELECT TVA_ID, TVA_DESIGN FROM TVA WHERE TVA_ACTIV = 1").executeQuery();
            ResultSet fournRSET = connex.prepareStatement("SELECT FO_ID, FO_NOM FROM FOURNISSEUR WHERE FO_ACTIV = 1").executeQuery();
            while(tvaRSET.next()){
                tvaCB.addItem(new classes.ComboObjet(tvaRSET.getString("TVA_DESIGN"),tvaRSET.getInt("TVA_ID")));
            }
            while(fournRSET.next()){
                fournCB.addItem(new classes.ComboObjet(fournRSET.getString("FO_NOM"),fournRSET.getInt("FO_ID")));
            }
            
        }catch(Exception e){
            System.out.println("[PaneProduits][initFournEtTVACB] Exception : " + e);
            e.printStackTrace();
        }
    }
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JPanel actionPane;
    private javax.swing.JButton addButton;
    private javax.swing.JTextField condiField;
    private javax.swing.JLabel condiLabel;
    private javax.swing.JButton delButton;
    private javax.swing.JComboBox fournCB;
    private javax.swing.JLabel fournLabel;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JPanel jPanel3;
    private javax.swing.JPanel jPanel8;
    private javax.swing.JTextField qtField;
    private javax.swing.JLabel qtLabel;
    private javax.swing.JTextField reaproField;
    private javax.swing.JLabel reaproLabel;
    private javax.swing.JTextField saisieCodeField;
    private javax.swing.JLabel saisieCodeLabel;
    private javax.swing.JTextField saisieDesignField;
    private javax.swing.JLabel saisieDesignLabel;
    private javax.swing.JPanel saisieSousPane1;
    private javax.swing.JPanel saisieSousPane2;
    private javax.swing.JPanel saisieSousPane3;
    private javax.swing.JComboBox statusCB;
    private javax.swing.JLabel statusLabel;
    private javax.swing.JComboBox tvaCB;
    private javax.swing.JLabel tvaLabel;
    private javax.swing.JTextField unitField;
    private javax.swing.JLabel unitLabel;
    private javax.swing.JTextField valueField;
    private javax.swing.JLabel valueLabel;
    // End of variables declaration//GEN-END:variables
    
}
